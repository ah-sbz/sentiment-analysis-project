name: CI
on:
    push:
        branches: [ main ]
        paths:
            - "src/**"
            - "data/**"
            - "tests/**"
            - "requirements.txt"
            - "requirements-docker.txt"
            - "pyproject.toml"
            - ".github/workflows/**"
            - "Dockerfile"
            - ".dockerignore"
    pull_request:
        paths:
            - "src/**"
            - "data/**"
            - "tests/**"
            - "requirements.txt"
            - "requirements-docker.txt"
            - "pyproject.toml"
            - ".github/workflows/**"
            - "Dockerfile"
            - ".dockerignore"

jobs:
    lint-and-format:
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Check out repository
              uses: actions/checkout@v4
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                python-version: 3.11
                cache: pip
                cache-dependency-path: requirements.txt
            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt
            - name: Run ruff linting check
              run: |
                ruff check .
            - name: Run ruff format check
              run: |
                ruff format . --check
            - name: Run mypy type checking
              run: |
                mypy --config-file=pyproject.toml .
    test:
      runs-on: ubuntu-latest
      timeout-minutes: 10
      steps:
          - name: Check out repository
            uses: actions/checkout@v4
          - name: Set up Python
            uses: actions/setup-python@v5
            with:
              python-version: 3.11
              cache: pip
              cache-dependency-path: requirements.txt
          - name: Install dependencies
            run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
          - name: Run tests with pytest
            env:
              MODEL_PATH: ${{ vars.MODEL_PATH || 'models/sentiment.joblib' }}
            run: pytest -v
    build-and-push:
      runs-on: ubuntu-latest
      timeout-minutes: 10
      needs: [ lint-and-format, test ]
      steps:
          - name: Check out repository
            uses: actions/checkout@v4
          - name: Log in to Docker Hub
            if: github.event_name == 'push' && github.ref == 'refs/heads/main'
            uses: docker/login-action@v3
            with:
              username: ${{ secrets.DOCKERHUB_USERNAME }}
              password: ${{ secrets.DOCKERHUB_TOKEN }}
          - name: Build and (conditionally) push Docker image
            uses: docker/build-push-action@v5
            with:
              build-args: |
                MODEL_PATH=${{ vars.MODEL_PATH || 'models/sentiment.joblib' }}
              context: .
              push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
              tags: ${{ secrets.DOCKERHUB_USERNAME }}/sentiment-analysis-app:latest
    notify:
      needs: [ lint-and-format, test, build-and-push ]
      if: always()
      runs-on: ubuntu-latest
      steps:
        - name: Prepare notification context
          id: context
          run: |
            RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              {
                echo "meta<<EOF"
                echo "Repo: ${{ github.repository }}"
                echo "PR: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}"
                echo "Branch: ${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}"
                echo "Commit: ${{ github.event.pull_request.head.sha }}"
                echo "Run: ${RUN_URL}"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
            else
              {
                echo "meta<<EOF"
                echo "Repo: ${{ github.repository }}"
                echo "Ref: ${{ github.ref_name }}"
                echo "Commit: ${{ github.sha }}"
                echo "Run: ${RUN_URL}"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
            fi
        - name: Notify failure
          if: ${{ contains(needs.*.result, 'failure') }}
          run: |
            curl \
            -H "X-Tags: rotating_light" \
            -H "Icon: https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/png/github-light.png" \
            -H "Title: CI/CD Workflow Failed" \
            -H "Content-Type: text/plain" \
            -d $'${{ steps.context.outputs.meta }}\nStatus: failure' \
            -H "Click: ${{ step.context.outputs.run_url }}" \
            ${{ secrets.NTFY_URL }}
        - name: Notify cancelled
          if: ${{ contains(needs.*.result, 'cancelled') }}
          run: |
            curl \
            -H "X-Tags: warning" \
            -H "Icon: https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/png/github-light.png" \
            -H "Title: CI/CD Workflow Cancelled" \
            -H "Content-Type: text/plain" \
            -d $'${{ steps.context.outputs.meta }}\nStatus: cancelled' \
            -H "Click: ${{ step.context.outputs.run_url }}" \
            ${{ secrets.NTFY_URL }}
        - name: Notify success
          if: ${{ !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled') }}
          run: |
            curl \
            -H "X-Tags: white_check_mark" \
            -H "Icon: https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/png/github-light.png" \
            -H "Title: CI/CD Workflow Successful" \
            -H "Content-Type: text/plain" \
            -d $'${{ steps.context.outputs.meta }}\nStatus: success' \
            -H "Click: ${{ step.context.outputs.run_url }}" \
            ${{ secrets.NTFY_URL }}
